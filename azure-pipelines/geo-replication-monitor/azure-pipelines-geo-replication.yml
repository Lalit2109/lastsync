trigger: none

schedules:
  - cron: "0 * * * *" # every hour on the hour
    displayName: "Hourly storage geo-replication check"
    branches:
      include:
        - main
    always: true

pool:
  # Use your existing self-hosted agent pool name here
  name: 'self-hosted'

variables:
  # Alert threshold in minutes
  ThresholdMinutes: 30

  # Mode: 'alert' (only send when over threshold) or 'report' (always send report)
  Mode: 'alert'

  # Logical environment label (shown in email subject/body)
  Environment: 'Prod'

  # Optional: Log Analytics workspace for dashboard/reporting
  # LogAnalyticsWorkspaceId: ''  # Uncomment and set if using Log Analytics
  # LogAnalyticsSharedKey: ''    # Uncomment and set as secret if using Log Analytics

stages:
  - stage: GeoReplicationMonitor
    displayName: 'Storage geo-replication monitor'
    jobs:
      - job: RunCheck
        displayName: 'Run geo-replication check'
        steps:
          - checkout: self

          - task: AzurePowerShell@5
            displayName: 'Run geo-replication script'
            inputs:
              azureSubscription: 'YOUR-AZURE-RM-SERVICE-CONNECTION'
              ScriptType: 'FilePath'
              ScriptPath: 'azure-pipelines/geo-replication-monitor/check-geo-replication.ps1'
              ScriptArguments: >
                -ThresholdMinutes $(ThresholdMinutes)
                -SendGridApiKey "$(SendGridApiKey)"
                -SendGridFrom "$(SendGridFrom)"
                -SendGridTo "$(SendGridTo)"
                -Mode "$(Mode)"
                -Environment "$(Environment)"
                $(if (variables['LogAnalyticsWorkspaceId']) { '-LogAnalyticsWorkspaceId "$(LogAnalyticsWorkspaceId)" ' })
                $(if (variables['LogAnalyticsSharedKey']) { '-LogAnalyticsSharedKey "$(LogAnalyticsSharedKey)" ' })
              azurePowerShellVersion: 'LatestVersion'
              pwsh: true


