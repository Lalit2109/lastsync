{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## Storage Account Geo-Replication Monitoring\n\nThis workbook monitors geo-replication lag for Azure Storage Accounts."
      },
      "name": "text - 1"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "timeRange",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "value": {
              "durationMs": 3600000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 3600000,
                  "displayName": "Last 1 hour"
                },
                {
                  "durationMs": 86400000,
                  "displayName": "Last 24 hours"
                },
                {
                  "durationMs": 604800000,
                  "displayName": "Last 7 days"
                }
              ],
              "allowCustom": true
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 1"
    },
    {
      "type": 1,
      "content": {
        "json": "### Summary Statistics"
      },
      "name": "text - 2"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlParameterItem/1.0",
        "queries": [
          {
            "query": "StorageGeoReplication_CL\n| where ServiceType_s_s == \"StorageGeoReplication\"\n| where TimeGenerated > ago({TimeRange})\n| summarize arg_max(TimeGenerated, *) by SubscriptionId_s_s, ResourceName_s_s\n| summarize \n    TotalAccounts = count(),\n    GeoReplicated = countif(IsGeoReplicated_b_b == true),\n    NotGeoReplicated = countif(IsGeoReplicated_b_b == false),\n    WithReadAccess = countif(HasReadAccess_b_b == true),\n    OverThreshold = countif(IsOverThreshold_b_b == true),\n    Healthy = countif(HasReadAccess_b_b == true and IsOverThreshold_b_b == false)\n| extend \n    GeoReplicationPercentage = round((GeoReplicated * 100.0 / TotalAccounts), 1),\n    HealthPercentage = round((Healthy * 100.0 / WithReadAccess), 1)\n| project TotalAccounts, GeoReplicated, NotGeoReplicated, WithReadAccess, \n         OverThreshold, Healthy, GeoReplicationPercentage, HealthPercentage",
            "id": "query1",
            "name": "Query 1"
          }
        ],
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "grid",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "TotalAccounts",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "GeoReplicated",
              "formatter": 4,
              "formatOptions": {
                "palette": "green"
              }
            },
            {
              "columnMatch": "OverThreshold",
              "formatter": 4,
              "formatOptions": {
                "palette": "red"
              }
            },
            {
              "columnMatch": "Healthy",
              "formatter": 4,
              "formatOptions": {
                "palette": "green"
              }
            }
          ]
        }
      },
      "name": "query - Summary Stats"
    },
    {
      "type": 1,
      "content": {
        "json": "### Storage Accounts with Geo-Replication Enabled (with Lag Status)"
      },
      "name": "text - 3"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlParameterItem/1.0",
        "queries": [
          {
            "query": "StorageGeoReplication_CL\n| where ServiceType_s_s == \"StorageGeoReplication\"\n| where TimeGenerated > ago({TimeRange})\n| where IsGeoReplicated_b_b == true\n| summarize arg_max(TimeGenerated, *) by SubscriptionId_s_s, ResourceName_s_s\n| project TimeGenerated, SubscriptionId_s_s, ResourceGroup_s_s, ResourceName_s_s, \n         Location = PrimaryLocation_s_s, SkuName_s_s, GeoReplicationStatus_s_s,\n         LagMinutes_d_d, ThresholdMinutes_d_d, IsOverThreshold_b_b\n| order by IsOverThreshold_b_b desc, LagMinutes_d_d desc nulls last",
            "id": "query2",
            "name": "Query 2"
          }
        ],
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "grid",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "LagMinutes_d_d",
              "formatter": 8,
              "formatOptions": {
                "min": 0,
                "palette": [
                  {
                    "value": 0,
                    "color": "#00ff00"
                  },
                  {
                    "value": null,
                    "color": "#808080"
                  }
                ],
                "custom": [
                  {
                    "condition": "IsOverThreshold_b_b == true",
                    "color": "#ff0000"
                  },
                  {
                    "condition": "LagMinutes_d_d > 0 and IsOverThreshold_b_b == false",
                    "color": "#ffff00"
                  },
                  {
                    "condition": "LagMinutes_d_d == 0 or LagMinutes_d_d == null",
                    "color": "#00ff00"
                  }
                ]
              }
            },
            {
              "columnMatch": "IsOverThreshold_b_b",
              "formatter": 5,
              "formatOptions": {
                "palette": [
                  {
                    "value": true,
                    "color": "#ff0000"
                  },
                  {
                    "value": false,
                    "color": "#00ff00"
                  }
                ]
              }
            }
          ],
          "rowConditionalFormatting": [
            {
              "condition": "IsOverThreshold_b_b == true",
              "backgroundColor": "#ffcccc"
            }
          ]
        }
      },
      "name": "query - GRS Enabled with Lag"
    },
    {
      "type": 1,
      "content": {
        "json": "### Accounts Over Threshold (Alert View)"
      },
      "name": "text - 4"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlParameterItem/1.0",
        "queries": [
          {
            "query": "StorageGeoReplication_CL\n| where ServiceType_s_s == \"StorageGeoReplication\"\n| where TimeGenerated > ago({TimeRange})\n| where IsGeoReplicated_b_b == true\n| where HasReadAccess_b_b == true\n| where IsOverThreshold_b_b == true\n| summarize arg_max(TimeGenerated, *) by SubscriptionId_s_s, ResourceName_s_s\n| project TimeGenerated, SubscriptionId_s_s, ResourceGroup_s_s, ResourceName_s_s,\n         Location = PrimaryLocation_s_s, SkuName_s_s, GeoReplicationStatus_s_s,\n         LagMinutes_d_d, ThresholdMinutes_d_d\n| extend LagOverThreshold = LagMinutes_d_d - ThresholdMinutes_d_d\n| order by LagOverThreshold desc",
            "id": "query3",
            "name": "Query 3"
          }
        ],
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "grid",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "LagMinutes_d_d",
              "formatter": 8,
              "formatOptions": {
                "min": 0,
                "palette": [
                  {
                    "value": 0,
                    "color": "#ff0000"
                  }
                ],
                "custom": [
                  {
                    "condition": "LagMinutes_d_d > ThresholdMinutes_d_d",
                    "color": "#ff0000"
                  }
                ]
              }
            }
          ],
          "rowConditionalFormatting": [
            {
              "condition": "IsOverThreshold_b_b == true",
              "backgroundColor": "#ffcccc"
            }
          ]
        }
      },
      "name": "query - Over Threshold"
    },
    {
      "type": 1,
      "content": {
        "json": "### Storage Accounts with Geo-Replication NOT Enabled"
      },
      "name": "text - 5"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlParameterItem/1.0",
        "queries": [
          {
            "query": "StorageGeoReplication_CL\n| where ServiceType_s_s == \"StorageGeoReplication\"\n| where TimeGenerated > ago({TimeRange})\n| where IsGeoReplicated_b_b == false\n| summarize arg_max(TimeGenerated, *) by SubscriptionId_s_s, ResourceName_s_s\n| project TimeGenerated, SubscriptionId_s_s, ResourceGroup_s_s, ResourceName_s_s,\n         Location = PrimaryLocation_s_s, SkuName_s_s\n| order by SubscriptionId_s_s, ResourceGroup_s_s, ResourceName_s_s",
            "id": "query4",
            "name": "Query 4"
          }
        ],
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "grid"
      },
      "name": "query - GRS NOT Enabled"
    },
    {
      "type": 1,
      "content": {
        "json": "### Lag Trend Over Time"
      },
      "name": "text - 6"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlParameterItem/1.0",
        "queries": [
          {
            "query": "StorageGeoReplication_CL\n| where ServiceType_s_s == \"StorageGeoReplication\"\n| where TimeGenerated > ago({TimeRange})\n| where IsGeoReplicated_b_b == true\n| where HasReadAccess_b_b == true\n| where isnotnull(LagMinutes_d_d)\n| summarize \n    AvgLag = avg(LagMinutes_d_d),\n    MaxLag = max(LagMinutes_d_d),\n    MinLag = min(LagMinutes_d_d)\n    by bin(TimeGenerated, 1h)\n| render timechart",
            "id": "query5",
            "name": "Query 5"
          }
        ],
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "linechart",
        "chartSettings": {
          "series": [
            {
              "name": "AvgLag",
              "label": "Average Lag (minutes)",
              "color": "#0078d4"
            },
            {
              "name": "MaxLag",
              "label": "Max Lag (minutes)",
              "color": "#ff0000"
            },
            {
              "name": "MinLag",
              "label": "Min Lag (minutes)",
              "color": "#00ff00"
            }
          ]
        }
      },
      "name": "query - Lag Trend"
    },
    {
      "type": 1,
      "content": {
        "json": "### Accounts by Geo-Replication Status"
      },
      "name": "text - 7"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlParameterItem/1.0",
        "queries": [
          {
            "query": "StorageGeoReplication_CL\n| where ServiceType_s_s == \"StorageGeoReplication\"\n| where TimeGenerated > ago({TimeRange})\n| summarize arg_max(TimeGenerated, *) by SubscriptionId_s_s, ResourceName_s_s\n| extend Status = case(\n    IsOverThreshold_b_b == true, \"Over Threshold\",\n    HasReadAccess_b_b == true and IsOverThreshold_b_b == false, \"Healthy (Monitored)\",\n    IsGeoReplicated_b_b == true and HasReadAccess_b_b == false, \"GRS (No Read Access)\",\n    \"Not Geo-Replicated\")\n| summarize Count = count() by Status\n| order by Count desc",
            "id": "query6",
            "name": "Query 6"
          }
        ],
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "donut",
        "chartSettings": {
          "series": [
            {
              "name": "Count",
              "label": "Count"
            }
          ]
        }
      },
      "name": "query - Status Breakdown"
    },
    {
      "type": 1,
      "content": {
        "json": "### Top 10 Accounts by Lag (Last 24 Hours)"
      },
      "name": "text - 8"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlParameterItem/1.0",
        "queries": [
          {
            "query": "StorageGeoReplication_CL\n| where ServiceType_s_s == \"StorageGeoReplication\"\n| where TimeGenerated > ago(24h)\n| where IsGeoReplicated_b_b == true\n| where HasReadAccess_b_b == true\n| where isnotnull(LagMinutes_d_d)\n| summarize MaxLag = max(LagMinutes_d_d) by SubscriptionId_s_s, ResourceName_s_s\n| top 10 by MaxLag desc\n| project SubscriptionId_s_s, ResourceName_s_s, MaxLag",
            "id": "query7",
            "name": "Query 7"
          }
        ],
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "barchart",
        "chartSettings": {
          "series": [
            {
              "name": "MaxLag",
              "label": "Max Lag (minutes)",
              "color": "#ff0000"
            }
          ]
        }
      },
      "name": "query - Top 10 by Lag"
    }
  ],
  "fallbackResourceIds": [],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}

